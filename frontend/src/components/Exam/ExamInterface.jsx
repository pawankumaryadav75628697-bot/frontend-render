import React, { useState, useEffect, useRef } from 'react';\nimport ProctoringSuite from '../Proctoring/ProctoringSuite';\nimport './ExamInterface.css';\n\nconst ExamInterface = ({ \n  examData,\n  studentInfo,\n  onExamSubmit,\n  onExamTerminate,\n  enableProctoring = true,\n  securityLevel = 'strict'\n}) => {\n  // Exam State\n  const [currentQuestion, setCurrentQuestion] = useState(0);\n  const [answers, setAnswers] = useState({});\n  const [timeRemaining, setTimeRemaining] = useState(examData?.duration * 60 || 7200); // seconds\n  const [examStarted, setExamStarted] = useState(false);\n  const [examSubmitted, setExamSubmitted] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [violations, setViolations] = useState([]);\n  \n  // Proctoring State\n  const [proctoringActive, setProctoringActive] = useState(false);\n  const [examTerminated, setExamTerminated] = useState(false);\n  const [terminationReason, setTerminationReason] = useState('');\n  \n  // Refs\n  const timerRef = useRef(null);\n  const examStartTimeRef = useRef(null);\n  const autoSaveRef = useRef(null);\n\n  // Sample exam data structure\n  const defaultExamData = {\n    id: 'EXAM_001',\n    title: 'Final Assessment - Computer Science',\n    duration: 120, // minutes\n    totalQuestions: 25,\n    passingScore: 70,\n    allowBacktrack: false,\n    shuffleQuestions: true,\n    instructions: [\n      'Read each question carefully before answering',\n      'You cannot go back to previous questions',\n      'Ensure stable internet connection throughout the exam',\n      'Do not switch tabs or applications during the exam',\n      'Keep your face visible to the camera at all times',\n      'Any suspicious activity will be flagged and may result in exam termination'\n    ],\n    questions: [\n      {\n        id: 1,\n        type: 'multiple-choice',\n        question: 'What is the time complexity of binary search in a sorted array?',\n        options: [\n          'O(n)',\n          'O(log n)',\n          'O(n log n)',\n          'O(1)'\n        ],\n        correctAnswer: 1,\n        points: 4\n      },\n      {\n        id: 2,\n        type: 'multiple-choice',\n        question: 'Which data structure uses LIFO (Last In First Out) principle?',\n        options: [\n          'Queue',\n          'Stack',\n          'Array',\n          'Linked List'\n        ],\n        correctAnswer: 1,\n        points: 4\n      },\n      {\n        id: 3,\n        type: 'essay',\n        question: 'Explain the concept of object-oriented programming and its main principles.',\n        maxLength: 1000,\n        points: 10\n      }\n    ]\n  };\n\n  const exam = examData || defaultExamData;\n  const student = studentInfo || {\n    id: 'STU001',\n    name: 'John Doe',\n    email: 'john.doe@university.edu'\n  };\n\n  // Timer Effect\n  useEffect(() => {\n    if (examStarted && !examSubmitted && !examTerminated) {\n      timerRef.current = setInterval(() => {\n        setTimeRemaining(prev => {\n          if (prev <= 1) {\n            handleTimeUp();\n            return 0;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n    }\n\n    return () => {\n      if (timerRef.current) {\n        clearInterval(timerRef.current);\n      }\n    };\n  }, [examStarted, examSubmitted, examTerminated]);\n\n  // Auto-save Effect\n  useEffect(() => {\n    if (examStarted && !examSubmitted) {\n      autoSaveRef.current = setInterval(() => {\n        saveProgress();\n      }, 30000); // Save every 30 seconds\n    }\n\n    return () => {\n      if (autoSaveRef.current) {\n        clearInterval(autoSaveRef.current);\n      }\n    };\n  }, [examStarted, examSubmitted, answers]);\n\n  const startExam = () => {\n    setExamStarted(true);\n    examStartTimeRef.current = new Date();\n    if (enableProctoring) {\n      setProctoringActive(true);\n    }\n    console.log('üéØ Exam Started', {\n      examId: exam.id,\n      studentId: student.id,\n      startTime: examStartTimeRef.current,\n      proctoring: enableProctoring\n    });\n  };\n\n  const handleAnswer = (questionId, answer) => {\n    setAnswers(prev => ({\n      ...prev,\n      [questionId]: {\n        answer,\n        timestamp: new Date(),\n        timeSpent: calculateTimeSpent()\n      }\n    }));\n  };\n\n  const calculateTimeSpent = () => {\n    if (!examStartTimeRef.current) return 0;\n    return Math.floor((new Date() - examStartTimeRef.current) / 1000);\n  };\n\n  const nextQuestion = () => {\n    if (currentQuestion < exam.questions.length - 1) {\n      setCurrentQuestion(prev => prev + 1);\n    }\n  };\n\n  const previousQuestion = () => {\n    if (exam.allowBacktrack && currentQuestion > 0) {\n      setCurrentQuestion(prev => prev - 1);\n    }\n  };\n\n  const saveProgress = () => {\n    const progressData = {\n      examId: exam.id,\n      studentId: student.id,\n      answers,\n      currentQuestion,\n      timeRemaining,\n      violations: violations.length,\n      timestamp: new Date()\n    };\n    \n    // Send to backend\n    console.log('üíæ Auto-saving progress:', progressData);\n  };\n\n  const handleTimeUp = () => {\n    console.log('‚è∞ Time up - Auto-submitting exam');\n    submitExam(true);\n  };\n\n  const submitExam = async (autoSubmit = false) => {\n    if (isSubmitting) return;\n    \n    setIsSubmitting(true);\n    \n    const submissionData = {\n      examId: exam.id,\n      studentId: student.id,\n      studentName: student.name,\n      answers,\n      timeSpent: calculateTimeSpent(),\n      timeRemaining,\n      autoSubmit,\n      violations,\n      submissionTime: new Date(),\n      proctoringData: {\n        violationCount: violations.length,\n        terminated: examTerminated,\n        terminationReason\n      }\n    };\n\n    try {\n      // Send to backend\n      console.log('üì§ Submitting exam:', submissionData);\n      \n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      \n      setExamSubmitted(true);\n      setProctoringActive(false);\n      \n      if (onExamSubmit) {\n        onExamSubmit(submissionData);\n      }\n      \n      console.log('‚úÖ Exam submitted successfully');\n    } catch (error) {\n      console.error('‚ùå Exam submission failed:', error);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleViolation = (violation) => {\n    setViolations(prev => [...prev, violation]);\n    console.warn('üö® Violation detected:', violation);\n  };\n\n  const handleExamTermination = (terminationData) => {\n    setExamTerminated(true);\n    setTerminationReason(terminationData.reason);\n    setProctoringActive(false);\n    \n    console.error('‚ùå Exam terminated:', terminationData);\n    \n    if (onExamTerminate) {\n      onExamTerminate(terminationData);\n    }\n  };\n\n  const formatTime = (seconds) => {\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n    \n    if (hours > 0) {\n      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n    }\n    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  const getAnsweredCount = () => {\n    return Object.keys(answers).length;\n  };\n\n  const renderQuestion = (question) => {\n    switch (question.type) {\n      case 'multiple-choice':\n        return (\n          <div className=\"question-content\">\n            <h3 className=\"question-text\">{question.question}</h3>\n            <div className=\"options-container\">\n              {question.options.map((option, index) => (\n                <label key={index} className=\"option-label\">\n                  <input\n                    type=\"radio\"\n                    name={`question-${question.id}`}\n                    value={index}\n                    checked={answers[question.id]?.answer === index}\n                    onChange={() => handleAnswer(question.id, index)}\n                    className=\"option-radio\"\n                  />\n                  <span className=\"option-text\">{option}</span>\n                </label>\n              ))}\n            </div>\n          </div>\n        );\n      \n      case 'essay':\n        return (\n          <div className=\"question-content\">\n            <h3 className=\"question-text\">{question.question}</h3>\n            <div className=\"essay-container\">\n              <textarea\n                className=\"essay-textarea\"\n                placeholder=\"Enter your answer here...\"\n                maxLength={question.maxLength}\n                value={answers[question.id]?.answer || ''}\n                onChange={(e) => handleAnswer(question.id, e.target.value)}\n              />\n              <div className=\"character-count\">\n                {(answers[question.id]?.answer || '').length} / {question.maxLength} characters\n              </div>\n            </div>\n          </div>\n        );\n      \n      default:\n        return <div>Unsupported question type</div>;\n    }\n  };\n\n  // Pre-exam screen\n  if (!examStarted) {\n    return (\n      <div className=\"exam-interface\">\n        <div className=\"pre-exam-container\">\n          <div className=\"exam-header\">\n            <h1>{exam.title}</h1>\n            <div className=\"exam-meta\">\n              <div className=\"meta-item\">\n                <span className=\"meta-label\">Duration:</span>\n                <span className=\"meta-value\">{exam.duration} minutes</span>\n              </div>\n              <div className=\"meta-item\">\n                <span className=\"meta-label\">Questions:</span>\n                <span className=\"meta-value\">{exam.questions.length}</span>\n              </div>\n              <div className=\"meta-item\">\n                <span className=\"meta-label\">Student:</span>\n                <span className=\"meta-value\">{student.name}</span>\n              </div>\n            </div>\n          </div>\n          \n          <div className=\"instructions-container\">\n            <h2>üìã Exam Instructions</h2>\n            <ul className=\"instructions-list\">\n              {exam.instructions.map((instruction, index) => (\n                <li key={index} className=\"instruction-item\">\n                  {instruction}\n                </li>\n              ))}\n            </ul>\n          </div>\n          \n          {enableProctoring && (\n            <div className=\"proctoring-notice\">\n              <h3>üîí Proctoring Information</h3>\n              <p>\n                This exam is monitored using AI-powered proctoring technology. \n                Your camera, microphone, and browser activity will be monitored \n                throughout the exam duration.\n              </p>\n              <div className=\"security-features\">\n                <div className=\"security-item\">‚úì Face Detection & Tracking</div>\n                <div className=\"security-item\">‚úì Audio Monitoring</div>\n                <div className=\"security-item\">‚úì Tab Switch Detection</div>\n                <div className=\"security-item\">‚úì Browser Lock Mode</div>\n              </div>\n            </div>\n          )}\n          \n          <button \n            className=\"start-exam-btn\"\n            onClick={startExam}\n          >\n            üöÄ START EXAM\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  // Post-exam screen\n  if (examSubmitted) {\n    return (\n      <div className=\"exam-interface\">\n        <div className=\"post-exam-container\">\n          <div className=\"success-icon\">‚úÖ</div>\n          <h1>Exam Submitted Successfully</h1>\n          <div className=\"submission-details\">\n            <div className=\"detail-row\">\n              <span className=\"detail-label\">Exam:</span>\n              <span className=\"detail-value\">{exam.title}</span>\n            </div>\n            <div className=\"detail-row\">\n              <span className=\"detail-label\">Student:</span>\n              <span className=\"detail-value\">{student.name}</span>\n            </div>\n            <div className=\"detail-row\">\n              <span className=\"detail-label\">Questions Answered:</span>\n              <span className=\"detail-value\">{getAnsweredCount()} / {exam.questions.length}</span>\n            </div>\n            <div className=\"detail-row\">\n              <span className=\"detail-label\">Time Used:</span>\n              <span className=\"detail-value\">{formatTime((exam.duration * 60) - timeRemaining)}</span>\n            </div>\n            <div className=\"detail-row\">\n              <span className=\"detail-label\">Submission Time:</span>\n              <span className=\"detail-value\">{new Date().toLocaleString()}</span>\n            </div>\n          </div>\n          <p className=\"submission-message\">\n            Your answers have been saved and submitted. You will receive your results \n            via email within 24-48 hours.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Terminated exam screen\n  if (examTerminated) {\n    return (\n      <div className=\"exam-interface\">\n        <div className=\"termination-container\">\n          <div className=\"termination-icon\">üö´</div>\n          <h1>Exam Session Terminated</h1>\n          <p className=\"termination-reason\">\n            Reason: {terminationReason}\n          </p>\n          <p className=\"termination-message\">\n            Your exam session has been automatically terminated due to policy violations. \n            Please contact your instructor or exam administrator for further assistance.\n          </p>\n          <div className=\"violation-count\">\n            Total Violations: {violations.length}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Main exam interface\n  return (\n    <div className=\"exam-interface\">\n      {/* Proctoring Suite */}\n      {enableProctoring && (\n        <ProctoringSuite\n          isActive={proctoringActive}\n          onExamTerminated={handleExamTermination}\n          onViolationReport={handleViolation}\n          examId={exam.id}\n          studentId={student.id}\n          studentName={student.name}\n          securityLevel={securityLevel}\n          maxWarnings={3}\n          autoTerminateOnMaxWarnings={true}\n          examDuration={exam.duration}\n        />\n      )}\n      \n      {/* Exam Header */}\n      <div className=\"exam-header-bar\">\n        <div className=\"exam-title\">{exam.title}</div>\n        <div className=\"exam-progress\">\n          <div className=\"progress-info\">\n            <span className=\"question-counter\">\n              Question {currentQuestion + 1} of {exam.questions.length}\n            </span>\n            <span className=\"answered-counter\">\n              Answered: {getAnsweredCount()}\n            </span>\n          </div>\n          <div className=\"timer\">\n            <span className={`time-display ${timeRemaining < 300 ? 'time-warning' : ''}`}>\n              ‚è±Ô∏è {formatTime(timeRemaining)}\n            </span>\n          </div>\n        </div>\n      </div>\n      \n      {/* Question Content */}\n      <div className=\"exam-content\">\n        <div className=\"question-container\">\n          <div className=\"question-header\">\n            <div className=\"question-number\">\n              Question {currentQuestion + 1}\n            </div>\n            <div className=\"question-points\">\n              {exam.questions[currentQuestion].points} points\n            </div>\n          </div>\n          \n          {renderQuestion(exam.questions[currentQuestion])}\n        </div>\n      </div>\n      \n      {/* Navigation */}\n      <div className=\"exam-navigation\">\n        <div className=\"nav-left\">\n          {exam.allowBacktrack && currentQuestion > 0 && (\n            <button \n              className=\"nav-btn prev-btn\"\n              onClick={previousQuestion}\n            >\n              ‚Üê Previous\n            </button>\n          )}\n        </div>\n        \n        <div className=\"nav-center\">\n          <div className=\"progress-bar\">\n            <div \n              className=\"progress-fill\"\n              style={{ width: `${((currentQuestion + 1) / exam.questions.length) * 100}%` }}\n            ></div>\n          </div>\n        </div>\n        \n        <div className=\"nav-right\">\n          {currentQuestion < exam.questions.length - 1 ? (\n            <button \n              className=\"nav-btn next-btn\"\n              onClick={nextQuestion}\n            >\n              Next ‚Üí\n            </button>\n          ) : (\n            <button \n              className=\"submit-btn\"\n              onClick={() => submitExam(false)}\n              disabled={isSubmitting}\n            >\n              {isSubmitting ? '‚è≥ Submitting...' : 'üì§ Submit Exam'}\n            </button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default ExamInterface;