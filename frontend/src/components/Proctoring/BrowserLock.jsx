import { useState, useEffect, useCallback, useRef } from 'react';\nimport { toast } from 'react-toastify';\n\nconst BrowserLock = ({ isActive, onViolation, examId, studentId }) => {\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const [violations, setViolations] = useState([]);\n  const [wakeLock, setWakeLock] = useState(null);\n  const windowFocusRef = useRef(true);\n  const lastActivityRef = useRef(Date.now());\n  const violationCooldownRef = useRef(new Set());\n\n  // Violation types\n  const VIOLATION_TYPES = {\n    TAB_SWITCH: 'tab_switch',\n    FULLSCREEN_EXIT: 'fullscreen_exit',\n    RIGHT_CLICK: 'right_click',\n    COPY_PASTE: 'copy_paste',\n    DEV_TOOLS: 'dev_tools',\n    SCREEN_CAPTURE: 'screen_capture',\n    MULTIPLE_MONITORS: 'multiple_monitors',\n    WINDOW_RESIZE: 'window_resize',\n    SUSPICIOUS_ACTIVITY: 'suspicious_activity'\n  };\n\n  // Log violation with cooldown to prevent spam\n  const logViolation = useCallback((type, details = {}) => {\n    const violationKey = `${type}-${Date.now()}`;\n    \n    // Check cooldown (5 seconds per violation type)\n    if (violationCooldownRef.current.has(type)) {\n      return;\n    }\n    \n    violationCooldownRef.current.add(type);\n    setTimeout(() => {\n      violationCooldownRef.current.delete(type);\n    }, 5000);\n\n    const violation = {\n      id: violationKey,\n      type,\n      timestamp: new Date().toISOString(),\n      examId,\n      studentId,\n      details,\n      severity: getViolationSeverity(type)\n    };\n\n    setViolations(prev => [...prev, violation]);\n    onViolation && onViolation(violation);\n\n    // Show toast notification\n    const message = getViolationMessage(type);\n    if (violation.severity === 'critical') {\n      toast.error(`üö® ${message}`);\n    } else if (violation.severity === 'major') {\n      toast.warn(`‚ö†Ô∏è ${message}`);\n    } else {\n      toast.info(`‚ÑπÔ∏è ${message}`);\n    }\n  }, [examId, studentId, onViolation]);\n\n  // Get violation severity\n  const getViolationSeverity = (type) => {\n    switch (type) {\n      case VIOLATION_TYPES.TAB_SWITCH:\n      case VIOLATION_TYPES.FULLSCREEN_EXIT:\n      case VIOLATION_TYPES.DEV_TOOLS:\n      case VIOLATION_TYPES.SCREEN_CAPTURE:\n        return 'critical';\n      case VIOLATION_TYPES.RIGHT_CLICK:\n      case VIOLATION_TYPES.COPY_PASTE:\n      case VIOLATION_TYPES.MULTIPLE_MONITORS:\n        return 'major';\n      default:\n        return 'minor';\n    }\n  };\n\n  // Get violation message\n  const getViolationMessage = (type) => {\n    switch (type) {\n      case VIOLATION_TYPES.TAB_SWITCH:\n        return 'Tab switching detected! Please stay on the exam page.';\n      case VIOLATION_TYPES.FULLSCREEN_EXIT:\n        return 'Fullscreen mode required for exam security.';\n      case VIOLATION_TYPES.RIGHT_CLICK:\n        return 'Right-click is disabled during the exam.';\n      case VIOLATION_TYPES.COPY_PASTE:\n        return 'Copy/paste operations are not allowed.';\n      case VIOLATION_TYPES.DEV_TOOLS:\n        return 'Developer tools usage detected!';\n      case VIOLATION_TYPES.SCREEN_CAPTURE:\n        return 'Screen recording software detected!';\n      default:\n        return 'Security violation detected.';\n    }\n  };\n\n  // Fullscreen management\n  const enterFullscreen = useCallback(async () => {\n    try {\n      if (document.documentElement.requestFullscreen) {\n        await document.documentElement.requestFullscreen();\n      } else if (document.documentElement.webkitRequestFullscreen) {\n        await document.documentElement.webkitRequestFullscreen();\n      } else if (document.documentElement.msRequestFullscreen) {\n        await document.documentElement.msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error('Failed to enter fullscreen:', error);\n      toast.error('Unable to enter fullscreen mode. Please try again.');\n    }\n  }, []);\n\n  const exitFullscreen = useCallback(async () => {\n    try {\n      if (document.exitFullscreen) {\n        await document.exitFullscreen();\n      } else if (document.webkitExitFullscreen) {\n        await document.webkitExitFullscreen();\n      } else if (document.msExitFullscreen) {\n        await document.msExitFullscreen();\n      }\n    } catch (error) {\n      console.error('Failed to exit fullscreen:', error);\n    }\n  }, []);\n\n  // Wake lock management\n  const requestWakeLock = useCallback(async () => {\n    try {\n      if ('wakeLock' in navigator) {\n        const wakeLockObj = await navigator.wakeLock.request('screen');\n        setWakeLock(wakeLockObj);\n        console.log('Screen wake lock activated');\n      }\n    } catch (error) {\n      console.error('Wake lock request failed:', error);\n    }\n  }, []);\n\n  const releaseWakeLock = useCallback(async () => {\n    if (wakeLock) {\n      try {\n        await wakeLock.release();\n        setWakeLock(null);\n        console.log('Screen wake lock released');\n      } catch (error) {\n        console.error('Wake lock release failed:', error);\n      }\n    }\n  }, [wakeLock]);\n\n  // Event handlers\n  const handleFullscreenChange = useCallback(() => {\n    const isCurrentlyFullscreen = !!(document.fullscreenElement ||\n      document.webkitFullscreenElement ||\n      document.msFullscreenElement);\n    \n    setIsFullscreen(isCurrentlyFullscreen);\n    \n    if (isActive && !isCurrentlyFullscreen) {\n      logViolation(VIOLATION_TYPES.FULLSCREEN_EXIT);\n      // Attempt to re-enter fullscreen after a short delay\n      setTimeout(enterFullscreen, 1000);\n    }\n  }, [isActive, logViolation, enterFullscreen]);\n\n  const handleVisibilityChange = useCallback(() => {\n    if (isActive && document.hidden) {\n      windowFocusRef.current = false;\n      logViolation(VIOLATION_TYPES.TAB_SWITCH, {\n        hidden: document.hidden,\n        visibilityState: document.visibilityState\n      });\n    } else {\n      windowFocusRef.current = true;\n    }\n  }, [isActive, logViolation]);\n\n  const handleWindowFocus = useCallback(() => {\n    windowFocusRef.current = true;\n    lastActivityRef.current = Date.now();\n  }, []);\n\n  const handleWindowBlur = useCallback(() => {\n    if (isActive) {\n      windowFocusRef.current = false;\n      logViolation(VIOLATION_TYPES.TAB_SWITCH, {\n        reason: 'window_blur',\n        timestamp: Date.now()\n      });\n    }\n  }, [isActive, logViolation]);\n\n  const handleContextMenu = useCallback((e) => {\n    if (isActive) {\n      e.preventDefault();\n      logViolation(VIOLATION_TYPES.RIGHT_CLICK, {\n        target: e.target.tagName,\n        coordinates: { x: e.clientX, y: e.clientY }\n      });\n    }\n  }, [isActive, logViolation]);\n\n  const handleKeyDown = useCallback((e) => {\n    if (!isActive) return;\n\n    const { key, ctrlKey, metaKey, altKey, shiftKey } = e;\n    \n    // Block common cheating shortcuts\n    const blockedKeys = [\n      'F12', // Dev tools\n      'F5',  // Refresh\n    ];\n\n    const blockedCombinations = [\n      { ctrl: true, key: 'c' }, // Copy\n      { ctrl: true, key: 'v' }, // Paste\n      { ctrl: true, key: 'x' }, // Cut\n      { ctrl: true, key: 'a' }, // Select all\n      { ctrl: true, key: 'f' }, // Find\n      { ctrl: true, key: 'h' }, // History\n      { ctrl: true, key: 'r' }, // Refresh\n      { ctrl: true, key: 's' }, // Save\n      { ctrl: true, key: 'p' }, // Print\n      { ctrl: true, key: 'u' }, // View source\n      { ctrl: true, shift: true, key: 'I' }, // Dev tools\n      { ctrl: true, shift: true, key: 'J' }, // Console\n      { ctrl: true, shift: true, key: 'C' }, // Inspector\n      { alt: true, key: 'Tab' }, // Alt+Tab\n      { meta: true, key: 'Tab' }, // Cmd+Tab (Mac)\n    ];\n\n    // Check blocked keys\n    if (blockedKeys.includes(key)) {\n      e.preventDefault();\n      if (key === 'F12') {\n        logViolation(VIOLATION_TYPES.DEV_TOOLS, { key, attempt: 'F12' });\n      }\n      return;\n    }\n\n    // Check blocked combinations\n    for (const combo of blockedCombinations) {\n      if ((combo.ctrl && ctrlKey) || (combo.meta && metaKey)) {\n        if (combo.shift && !shiftKey) continue;\n        if (!combo.shift && shiftKey && (combo.key === 'I' || combo.key === 'J' || combo.key === 'C')) continue;\n        if (combo.alt && !altKey) continue;\n        \n        if (combo.key.toLowerCase() === key.toLowerCase()) {\n          e.preventDefault();\n          \n          if (['c', 'v', 'x'].includes(combo.key)) {\n            logViolation(VIOLATION_TYPES.COPY_PASTE, { key, combination: `${ctrlKey ? 'Ctrl+' : 'Cmd+'}${key}` });\n          } else if (['I', 'J', 'C'].includes(combo.key) && shiftKey) {\n            logViolation(VIOLATION_TYPES.DEV_TOOLS, { key, combination: `Ctrl+Shift+${key}` });\n          }\n          return;\n        }\n      }\n    }\n\n    // Track activity\n    lastActivityRef.current = Date.now();\n  }, [isActive, logViolation]);\n\n  // Monitor for screen recording software\n  const checkForScreenRecording = useCallback(() => {\n    if (!isActive) return;\n\n    // Check for common screen recording indicators\n    try {\n      // Check for navigator.mediaDevices.getDisplayMedia usage\n      if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {\n        // This is a basic check - in a real implementation, you'd need more sophisticated detection\n        const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;\n        navigator.mediaDevices.getDisplayMedia = function(...args) {\n          logViolation(VIOLATION_TYPES.SCREEN_CAPTURE, {\n            method: 'getDisplayMedia',\n            timestamp: Date.now()\n          });\n          return originalGetDisplayMedia.apply(this, args);\n        };\n      }\n    } catch (error) {\n      console.error('Error setting up screen recording detection:', error);\n    }\n  }, [isActive, logViolation]);\n\n  // Monitor window resize (potential multi-monitor setup)\n  const handleWindowResize = useCallback(() => {\n    if (isActive) {\n      const { innerWidth, innerHeight, outerWidth, outerHeight } = window;\n      const { availWidth, availHeight } = window.screen;\n      \n      // Check if window is significantly smaller than screen (potential windowed mode)\n      if (innerWidth < availWidth * 0.9 || innerHeight < availHeight * 0.9) {\n        logViolation(VIOLATION_TYPES.WINDOW_RESIZE, {\n          windowSize: { width: innerWidth, height: innerHeight },\n          screenSize: { width: availWidth, height: availHeight },\n          ratio: { width: innerWidth / availWidth, height: innerHeight / availHeight }\n        });\n      }\n    }\n  }, [isActive, logViolation]);\n\n  // Setup event listeners\n  useEffect(() => {\n    if (!isActive) return;\n\n    // Fullscreen events\n    document.addEventListener('fullscreenchange', handleFullscreenChange);\n    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);\n    document.addEventListener('msfullscreenchange', handleFullscreenChange);\n\n    // Visibility and focus events\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    window.addEventListener('focus', handleWindowFocus);\n    window.addEventListener('blur', handleWindowBlur);\n\n    // Input events\n    document.addEventListener('contextmenu', handleContextMenu);\n    document.addEventListener('keydown', handleKeyDown);\n    window.addEventListener('resize', handleWindowResize);\n\n    // Initialize security measures\n    enterFullscreen();\n    requestWakeLock();\n    checkForScreenRecording();\n\n    return () => {\n      // Cleanup event listeners\n      document.removeEventListener('fullscreenchange', handleFullscreenChange);\n      document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);\n      document.removeEventListener('msfullscreenchange', handleFullscreenChange);\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n      window.removeEventListener('focus', handleWindowFocus);\n      window.removeEventListener('blur', handleWindowBlur);\n      document.removeEventListener('contextmenu', handleContextMenu);\n      document.removeEventListener('keydown', handleKeyDown);\n      window.removeEventListener('resize', handleWindowResize);\n      \n      // Release wake lock\n      releaseWakeLock();\n    };\n  }, [isActive, handleFullscreenChange, handleVisibilityChange, handleWindowFocus, \n      handleWindowBlur, handleContextMenu, handleKeyDown, handleWindowResize,\n      enterFullscreen, requestWakeLock, checkForScreenRecording, releaseWakeLock]);\n\n  // Cleanup on component unmount\n  useEffect(() => {\n    return () => {\n      if (!isActive) {\n        exitFullscreen();\n        releaseWakeLock();\n      }\n    };\n  }, [isActive, exitFullscreen, releaseWakeLock]);\n\n  // Periodic activity check\n  useEffect(() => {\n    if (!isActive) return;\n\n    const activityInterval = setInterval(() => {\n      const timeSinceLastActivity = Date.now() - lastActivityRef.current;\n      \n      // Check for suspicious inactivity (more than 5 minutes)\n      if (timeSinceLastActivity > 5 * 60 * 1000) {\n        logViolation(VIOLATION_TYPES.SUSPICIOUS_ACTIVITY, {\n          reason: 'extended_inactivity',\n          duration: timeSinceLastActivity\n        });\n      }\n    }, 60000); // Check every minute\n\n    return () => clearInterval(activityInterval);\n  }, [isActive, logViolation]);\n\n  if (!isActive) {\n    return null;\n  }\n\n  return (\n    <div className=\"browser-lock-overlay\">\n      {/* Security Status Indicator */}\n      <div className=\"security-status\">\n        <div className={`status-indicator ${isFullscreen ? 'active' : 'inactive'}`}>\n          <span className=\"status-icon\">{isFullscreen ? 'üîí' : '‚ö†Ô∏è'}</span>\n          <span className=\"status-text\">\n            {isFullscreen ? 'Secure Mode Active' : 'Security Warning'}\n          </span>\n        </div>\n        \n        {violations.length > 0 && (\n          <div className=\"violation-counter\">\n            <span className=\"violation-icon\">‚ö†Ô∏è</span>\n            <span className=\"violation-count\">{violations.length}</span>\n          </div>\n        )}\n      </div>\n\n      {/* Fullscreen Prompt */}\n      {!isFullscreen && (\n        <div className=\"fullscreen-prompt\">\n          <div className=\"prompt-content\">\n            <h3>üîí Secure Mode Required</h3>\n            <p>This exam requires fullscreen mode for security. Please click the button below to continue.</p>\n            <button className=\"fullscreen-btn\" onClick={enterFullscreen}>\n              Enter Secure Mode\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default BrowserLock;